# KDB Arduino Debugger

Arduino用のリアルタイムデバッガライブラリです。WebSocketサーバーとWebUIを使用してArduinoプログラムのデバッグを行えます。

## 特徴

- **リアルタイムデバッグ**: プログラム実行中にブレークポイントで停止
- **変数監視**: `kdbcap(変数名)` で変数値をキャプチャして監視
- **メモリアクセス**: リアルタイムでメモリの読み書き
- **ピン制御**: デジタルピンの読み書き
- **WebUI**: ブラウザから直感的に操作（自動起動対応）
- **.inoファイル表示**: プロジェクトファイルを自動検索・表示
- **分離された構造**: Arduinoライブラリとサーバーコードを分離
- **ヘッダーファイル対応**: 標準的なC++ライブラリ構造

## ファイル構成

```
ardebug/
├── kdb.h                # Arduinoライブラリヘッダーファイル
├── kdb.cpp              # Arduinoライブラリ実装ファイル
├── requirements.txt     # Python依存関係
├── README.md            # メインドキュメント（このファイル）
├── README_KDB_Library.md # ライブラリ詳細ドキュメント
├── examples/
│   └── example.ino      # 使用例スケッチ
└── python/
    ├── kdb.py           # Python WebSocketサーバー
    ├── cli.py           # CUI版デバッガ
    ├── index.html       # WebUI メインページ
    ├── script.js        # WebUI JavaScriptロジック
    └── style.css        # WebUI スタイルシート
```

## セットアップ

### 1. Python環境の準備

```bash
# 依存関係をインストール
pip install -r requirements.txt
```

### 2. Arduino側の設定

このリポジトリをzipファイルとしてダウンロードしてライブラリにインストール

```cpp
#include "kdb.h"

int count = 0;

void setup() {
    Serial.begin(9600);  // ボーレート設定
    kdbinit;             // デバッガ初期化
    kdbcap(count);       // 変数をキャプチャ
}

void loop() {
    count++;
    kdbd;                // デバッガでブレーク
}
```

### 3. サーバーの起動

```bash
python python/kdb.py
```

### 4. WebUIへのアクセス

サーバーを起動すると、自動的にブラウザで `python/index.html` が開きます。

### 5. CUI版デバッガの使用

コマンドライン版のデバッガも利用できます：

```bash
python3 python/cli.py
```

CUI版では以下のコマンドが使用できます：
- `ports`: シリアルポート一覧表示
- `connect <port>`: Arduino接続
- `files`: .inoファイル検索
- `load <file>`: ファイル読み込み
- `show`: ファイル内容表示
- `continue`: デバッグ継続
- `captures`: 変数一覧
- `read <id>`: キャプチャデータ読み取り
- `mem <addr>`: メモリ読み取り
- `pin <pin>`: ピン読み取り
- その他詳細は `help` コマンドで確認

## 使用方法

### 基本的な流れ

1. **サーバー起動**: `python python/kdb.py` を実行
2. **WebUI開く**: ブラウザで自動的に開かれるWebUIを使用
3. **接続**: WebUIからArduinoのシリアルポートに接続
4. **ファイル読み込み**: .inoファイルを選択して表示
5. **デバッグ開始**: Arduinoプログラムが自動的にブレークポイントで停止

### KDBマクロ

#### `kdbinit`
- デバッガを初期化
- `setup()`関数の最初で呼び出し

#### `kdbcap(変数名)`
- 変数をキャプチャして監視対象に登録
- WebUIから値を読み取り可能

#### `kdbd`
- デバッガでブレークポイントを設定
- この行で実行が停止し、WebUIで操作可能になる

### WebUI機能

#### 接続設定
- **ポート選択**: Arduinoが接続されているシリアルポートを選択
- **ボーレート**: 通信速度設定（デフォルト: 9600）
- **接続/切断**: Arduinoとの接続制御

#### ファイル管理
- **ファイル検索**: カレントディレクトリから.inoファイルを自動検索
- **ファイル表示**: 選択したファイルをシンタックスハイライト付きで表示

#### デバッガ制御
- **実行継続**: ブレークポイントから実行を継続
- **現在行表示**: 実行中の行をハイライト表示

#### 変数監視
- **キャプチャ変数一覧**: `kdbcap()`で登録した変数の一覧
- **値の読み取り**: リアルタイムで変数値を取得

#### 詳細機能

**ログタブ**
- サーバーとの通信ログ
- デバッグ情報の表示

**メモリタブ**
- メモリアドレスの直接読み取り
- 16進数表示

**ピン制御タブ**
- デジタルピンの読み取り
- デジタルピンへの書き込み（HIGH/LOW）

## プロトコル仕様

### パケットフォーマット
```
0xA0 | 0x1E | OpType | OpValueSize | ...OpValues
```

### 操作タイプ

| OpType | 名前 | 説明 |
|--------|------|------|
| 0 | RETURN | 実行継続 |
| 1 | READ_MEM | メモリ読み取り |
| 2 | WRITE_MEM | メモリ書き込み |
| 3 | READ_CAP | キャプチャデータ読み取り |
| 4 | WRITE_CAP | キャプチャデータ書き込み |
| 5 | READ_PIN | ピン読み取り |
| 6 | WRITE_PIN | ピン書き込み |
| 7 | INIT | 初期化 |
| 8 | DEBUGGER | デバッガブレーク |
| 9 | CAPTURE | 変数キャプチャ |
| 10 | READ_MEM_RES | メモリ読み取り結果 |
| 11 | READ_CAP_RES | キャプチャ読み取り結果 |
| 12 | READ_PIN_RES | ピン読み取り結果 |

## トラブルシューティング

### 接続できない場合
- シリアルポートが正しく選択されているか確認
- Arduinoがコンピュータに認識されているか確認
- ボーレートが一致しているか確認（Arduino側のSerial.begin()と同じ値）

### Webサーバーに接続できない場合
- `python python/kdb.py` でサーバーが正常に起動しているか確認
- ファイアウォールでポート8765がブロックされていないか確認
- ブラウザのコンソールでエラーメッセージを確認

### デバッガが動作しない場合
- `kdbinit` がsetup()関数で呼ばれているか確認
- シリアル通信が正常に行われているか確認
- Arduinoプログラムに `#include "kdb.h"` が含まれているか確認

## ライセンス

This project is open source.
